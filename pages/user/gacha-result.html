<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¬ãƒãƒ£çµæœ - å®¿ã‚¬ãƒãƒ£</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="menu-button" id="menuButton">â˜°</button>
                <img src="../../assets/images/logo.png" alt="å®¿ã‚¬ãƒãƒ£" class="logo-image">
            </div>
            <nav class="nav-links">
                <a href="mypage.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a>
            </nav>
        </div>
    </header>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="menu-modal" id="menuModal">
        <div class="menu-content">
            <div class="menu-header">
                <h2>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <button class="menu-close" id="menuClose">âœ•</button>
            </div>
            
            <div class="menu-section">
                <h3>ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘</h3>
                <a href="../../index.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ </span>
                    <span>ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</span>
                </a>
                <a href="mypage.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ‘¤</span>
                    <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>
                </a>
            </div>
            
            <div class="menu-section">
                <h3>ãƒ›ãƒ†ãƒ«ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å‘ã‘</h3>
                <a href="../partner/dashboard.html" class="menu-item">
                    <span class="menu-item-icon">ğŸ“Š</span>
                    <span>ç®¡ç†ç”»é¢</span>
                </a>
            </div>
            
            <div class="menu-footer">
                <button class="logout-button" onclick="handleLogout()">
                    <span class="menu-item-icon">ğŸšª</span>
                    <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
                </button>
            </div>
        </div>
    </div>

    <main class="container">
        <!-- ã‚¬ãƒãƒ£æ¼”å‡ºå‹•ç”» -->
        <div id="gachaAnimation" class="gacha-fullscreen" style="display: none;">
            <video id="gachaVideo" class="gacha-video" muted playsinline>
                <source src="../../assets/images/ã‚¬ãƒãƒ£æ¼”å‡º.mp4" type="video/mp4">
                ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚¿ã‚°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
            </video>
        </div>

        <!-- å½“æ—¥ã‚ã‹ã‚‹ã‚¬ãƒãƒ£ã®å ´åˆã®è¡¨ç¤º -->
        <div id="pendingResult" class="card" style="display: none;">
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 5rem; margin-bottom: 20px;">ğŸ</div>
                <h1 style="color: #667eea; margin-bottom: 20px;">äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h1>
                <p style="font-size: 1.2rem; margin-bottom: 30px;">
                    å®¿æ³Šå…ˆã¯<span id="revealDate" style="color: #f5576c; font-weight: bold;"></span>ã«ç™ºè¡¨ã•ã‚Œã¾ã™
                </p>
                <div class="countdown">
                    <p style="margin-bottom: 10px;">ç™ºè¡¨ã¾ã§</p>
                    <div class="countdown-number" id="countdownDays">--</div>
                    <p>æ—¥</p>
                </div>
                <button class="btn btn-primary" style="margin-top: 30px;" onclick="window.location.href='mypage.html'">
                    ãƒã‚¤ãƒšãƒ¼ã‚¸ã§è©³ç´°ã‚’ç¢ºèª
                </button>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="resultContainer" class="result-container" style="display: none;">
            <div class="card">
                <h1 id="congratsMessage" style="text-align: center; color: #667eea; margin-bottom: 30px;">
                    ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼
                </h1>
                
                <img id="hotelImage" class="hotel-image" src="" alt="">
                
                <div class="hotel-info">
                    <h2 id="hotelName"></h2>
                    
                    <div class="hotel-meta">
                        <div class="meta-item">
                            <span>ğŸ“</span>
                            <span id="hotelAddress"></span>
                        </div>
                        <div class="meta-item">
                            <span>ğŸ“</span>
                            <span id="hotelPhone"></span>
                        </div>
                        <div class="meta-item">
                            <span>ğŸ•</span>
                            <span>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³: <span id="checkInTime"></span></span>
                        </div>
                        <div class="meta-item">
                            <span>ğŸ•‘</span>
                            <span>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ: <span id="checkOutTime"></span></span>
                        </div>
                    </div>
                    
                    <p id="hotelDescription" style="margin-top: 20px; line-height: 1.8; color: #666;"></p>
                    
                    <div class="features-grid" id="featuresGrid">
                        <!-- ç‰¹å¾´ã‚¿ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">ğŸ“‹ äºˆç´„è©³ç´°</h3>
                <div id="reservationDetails">
                    <!-- äºˆç´„è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <!-- è¦³å…‰ãƒ—ãƒ©ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="tourismPlanContainer" style="margin-top: 20px;">
                <!-- è¦³å…‰ãƒ—ãƒ©ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="retryButton" class="btn btn-warning" style="margin-bottom: 10px; display: none;">
                    ã‚‚ã†ä¸€åº¦å›ã™<span id="retryCount"></span>
                </button>
                <button id="referralButton" class="btn btn-info" style="margin-bottom: 10px; display: none;">
                    ğŸ å‹é”ã‚’ç´¹ä»‹ã—ã¦ã‚‚ã†ä¸€åº¦å›ã™
                </button>
                <div>
                    <button class="btn btn-success" onclick="window.location.href='mypage.html'">
                        ã“ã®å®¿ã§äºˆç´„ç¢ºå®š
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Canvas Confetti ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="../../js/data.js"></script>
    <script src="../../js/tourism-data.js"></script>
    <script src="../../js/image-loader.js"></script>
    <script src="../../js/menu.js"></script>
    <script src="../../js/confetti.js"></script>
    <script>
        const reservationId = sessionStorage.getItem('latestReservationId');
        
        if (!reservationId) {
            window.location.href = '../../index.html';
        }

        // äºˆç´„æƒ…å ±ã‚’å–å¾—
        const reservations = getReservations();
        const reservation = reservations.find(r => r.id === reservationId);
        
        if (!reservation) {
            window.location.href = '../../index.html';
        }

        // ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’å–å¾—
        const hotels = getHotels();
        const hotel = hotels.find(h => h.id === reservation.hotelId);

        // ãƒ—ãƒ©ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ†å²
        if (reservation.planType === 'instant' || reservation.status === 'revealed') {
            showGachaAnimation();
        } else {
            showPendingResult();
        }

        function showGachaAnimation() {
            document.getElementById('gachaAnimation').style.display = 'flex';
            const video = document.getElementById('gachaVideo');
            
            // å‹•ç”»ã‚’æœ€åˆã‹ã‚‰å†ç”Ÿ
            video.currentTime = 0;
            
            // å‹•ç”»å†ç”Ÿã‚’è©¦ã¿ã‚‹
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        // å†ç”ŸæˆåŠŸ
                        console.log('å‹•ç”»å†ç”Ÿé–‹å§‹');
                    })
                    .catch((error) => {
                        console.error('å‹•ç”»å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                        // å†ç”Ÿã§ããªã„å ´åˆã¯3ç§’å¾Œã«çµæœã‚’è¡¨ç¤º
                        setTimeout(() => {
                            document.getElementById('gachaAnimation').style.display = 'none';
                            showResult();
                        }, 3000);
                    });
            }
            
            // å‹•ç”»çµ‚äº†æ™‚ã«çµæœã‚’è¡¨ç¤º
            video.addEventListener('ended', function() {
                document.getElementById('gachaAnimation').style.display = 'none';
                showResult();
            }, { once: true }); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘å®Ÿè¡Œ
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šï¼ˆå‹•ç”»ãŒ10ç§’ä»¥ä¸Šã®å ´åˆã®ä¿é™ºï¼‰
            setTimeout(() => {
                if (document.getElementById('gachaAnimation').style.display !== 'none') {
                    document.getElementById('gachaAnimation').style.display = 'none';
                    showResult();
                }
            }, 10000);
        }

        function showPendingResult() {
            document.getElementById('pendingResult').style.display = 'block';
            
            const revealDate = new Date(reservation.revealDate);
            document.getElementById('revealDate').textContent = revealDate.toLocaleDateString('ja-JP');
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨ˆç®—
            const now = new Date();
            const daysUntilReveal = Math.ceil((revealDate - now) / (1000 * 60 * 60 * 24));
            document.getElementById('countdownDays').textContent = daysUntilReveal;
        }

        function showResult() {
            document.getElementById('resultContainer').style.display = 'block';
            
            // ç‰¹åˆ¥ãƒ›ãƒ†ãƒ«ã®å ´åˆã¯ç‰¹åˆ¥ãªæ¼”å‡º
            if (hotel.id === 'hotel_001' || hotel.id === 'hotel_010') {
                // ãŠç¥ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç‰¹åˆ¥ä»•æ§˜ã«
                const congratsMessage = document.getElementById('congratsMessage');
                congratsMessage.innerHTML = '<span class="jackpot-text">ğŸŠ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸŠ</span>';
                congratsMessage.classList.add('jackpot-animation');
                
                setTimeout(() => {
                    showConfetti();
                }, 500); // çµæœè¡¨ç¤ºã‹ã‚‰å°‘ã—é…ã‚‰ã›ã¦æ¼”å‡º
            }
            
            // ãƒ›ãƒ†ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
            const hotelImage = document.getElementById('hotelImage');
            loadHotelImage(hotelImage, hotel, '../../');
            // ãƒ›ãƒ†ãƒ«åã‚’è¡¨ç¤ºï¼ˆhotel_001ã®å ´åˆã¯ç‰¹åˆ¥ãƒãƒƒã‚¸ä»˜ãï¼‰
            const hotelNameElement = document.getElementById('hotelName');
            hotelNameElement.textContent = hotel.name;
            if (hotel.id === 'hotel_001' || hotel.id === 'hotel_010') {
                const badge = document.createElement('span');
                badge.className = 'special-badge';
                badge.textContent = 'âœ¨ ã‚¹ãƒšã‚·ãƒ£ãƒ«';
                hotelNameElement.appendChild(badge);
            }
            document.getElementById('hotelAddress').textContent = hotel.address;
            document.getElementById('hotelPhone').textContent = hotel.phone;
            document.getElementById('checkInTime').textContent = hotel.checkIn;
            document.getElementById('checkOutTime').textContent = hotel.checkOut;
            document.getElementById('hotelDescription').textContent = hotel.description;
            
            // ç‰¹å¾´ã‚¿ã‚°
            const featuresGrid = document.getElementById('featuresGrid');
            hotel.features.forEach(feature => {
                const tag = document.createElement('span');
                tag.className = 'feature-tag';
                tag.textContent = feature;
                featuresGrid.appendChild(tag);
            });
            
            // äºˆç´„è©³ç´°
            const checkInDate = new Date(reservation.checkInDate);
            const checkOutDate = new Date(reservation.checkInDate);
            checkOutDate.setDate(checkOutDate.getDate() + reservation.nights);
            
            document.getElementById('reservationDetails').innerHTML = `
                <div style="display: grid; gap: 10px; font-size: 0.95rem;">
                    <div><strong>äºˆç´„ç•ªå·:</strong> ${reservation.id}</div>
                    <div><strong>å®¿æ³Šè€…å:</strong> ${reservation.guestName}</div>
                    <div><strong>ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³:</strong> ${checkInDate.toLocaleDateString('ja-JP')}</div>
                    <div><strong>ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ:</strong> ${checkOutDate.toLocaleDateString('ja-JP')}</div>
                    <div><strong>å®¿æ³Šæ•°:</strong> ${reservation.nights}æ³Š</div>
                    <div><strong>äººæ•°:</strong> ${reservation.guests}å</div>
                    <div><strong>æ–™é‡‘:</strong> Â¥${reservation.price.toLocaleString()}</div>
                    ${reservation.attempts > 1 ? `<div style="color: #f5576c;"><strong>ã‚¬ãƒãƒ£å›æ•°:</strong> ${reservation.attempts}å›ç›®${reservation.referralBonus ? ' (å‹é”ç´¹ä»‹ãƒœãƒ¼ãƒŠã‚¹)' : ''}</div>` : ''}
                </div>
            `;
            
            // è¦³å…‰ãƒ—ãƒ©ãƒ³ã‚’è¡¨ç¤º
            const tourismPlanHTML = generateTourismPlanHTML(hotel.area);
            if (tourismPlanHTML) {
                document.getElementById('tourismPlanContainer').innerHTML = tourismPlanHTML;
            }
            
            // ã‚‚ã†ä¸€åº¦å›ã™ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆæœ€å¤§2å›ã¾ã§ï¼‰
            if (reservation.attempts < 2) {
                document.getElementById('retryButton').style.display = 'inline-block';
                document.getElementById('retryCount').textContent = `ï¼ˆæ®‹ã‚Š${2 - reservation.attempts}å›ï¼‰`;
            } else {
                // 2å›å›ã—ãŸå¾Œã¯ç´¹ä»‹ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('referralButton').style.display = 'inline-block';
            }
        }
        
        // ã‚‚ã†ä¸€åº¦å›ã™ãƒœã‚¿ãƒ³ã®å‡¦ç†
        document.getElementById('retryButton').addEventListener('click', function() {
            let warningMessage;
            
            // 2å›ç›®ï¼ˆæœ€å¾Œï¼‰ã®è­¦å‘Š
            warningMessage = 'âš ï¸ æœ€çµ‚è­¦å‘Šï¼šã“ã‚ŒãŒæœ€å¾Œã®ã‚¬ãƒãƒ£ã§ã™ï¼\n\n' +
                            'ãƒ»æ¬¡ã®çµæœã§ç¢ºå®šã¨ãªã‚Šã¾ã™\n' +
                            'ãƒ»ã‚‚ã†å¤‰æ›´ã¯ã§ãã¾ã›ã‚“\n' +
                            'ãƒ»ç¾åœ¨ã®å®¿ã«ã¯æˆ»ã‚Œã¾ã›ã‚“\n\n' +
                            'æœ¬å½“ã«æœ€å¾Œã®ã‚¬ãƒãƒ£ã‚’å›ã—ã¾ã™ã‹ï¼Ÿ';
            
            if (!confirm(warningMessage)) {
                return;
            }
            
            // æ–°ã—ã„ãƒ›ãƒ†ãƒ«ã‚’é¸æŠ
            const hotels = getHotels().filter(h => h.area === reservation.area && h.id !== reservation.hotelId);
            if (hotels.length === 0) {
                alert('ä»–ã®å®¿æ³Šæ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }
            
            const newHotel = hotels[Math.floor(Math.random() * hotels.length)];
            
            // æ—¢å­˜ã®äºˆç´„ã‚’æ›´æ–°
            const reservations = getReservations();
            const index = reservations.findIndex(r => r.id === reservation.id);
            if (index !== -1) {
                reservations[index].hotelId = newHotel.id;
                reservations[index].attempts = (reservations[index].attempts || 1) + 1;
                localStorage.setItem('yadogacha_reservations', JSON.stringify(reservations));
            }
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
            window.location.reload();
        });
        
        // å‹é”ç´¹ä»‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
        document.getElementById('referralButton').addEventListener('click', function() {
            if (confirm('ğŸ‘¥ å‹é”ç´¹ä»‹ãƒœãƒ¼ãƒŠã‚¹ï¼\n\nå‹é”ã‚’ç´¹ä»‹ã—ã¦ã„ãŸã ã„ãŸãŠç¤¼ã¨ã—ã¦ã€ç‰¹åˆ¥ã«ã‚‚ã†1å›ã‚¬ãƒãƒ£ã‚’å›ã›ã¾ã™ï¼\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
                // æ–°ã—ã„ãƒ›ãƒ†ãƒ«ã‚’é¸æŠ
                const hotels = getHotels().filter(h => h.area === reservation.area && h.id !== reservation.hotelId);
                if (hotels.length === 0) {
                    alert('ä»–ã®å®¿æ³Šæ–½è¨­ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }
                
                const newHotel = hotels[Math.floor(Math.random() * hotels.length)];
                
                // æ—¢å­˜ã®äºˆç´„ã‚’æ›´æ–°ï¼ˆattempts ã‚’3ã«è¨­å®šã—ã¦ã€ç´¹ä»‹ãƒœãƒ¼ãƒŠã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’è¨˜éŒ²ï¼‰
                const reservations = getReservations();
                const index = reservations.findIndex(r => r.id === reservation.id);
                if (index !== -1) {
                    reservations[index].hotelId = newHotel.id;
                    reservations[index].attempts = 3; // ç´¹ä»‹ãƒœãƒ¼ãƒŠã‚¹
                    reservations[index].referralBonus = true;
                    localStorage.setItem('yadogacha_reservations', JSON.stringify(reservations));
                }
                
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                window.location.reload();
            }
        });
    </script>
</body>
</html>