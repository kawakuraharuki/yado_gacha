<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ガチャ結果 - 宿ガチャ</title>
    <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <button class="menu-button" id="menuButton">☰</button>
                <img src="../../assets/images/logo.png" alt="宿ガチャ" class="logo-image">
            </div>
            <nav class="nav-links">
                <a href="mypage.html">マイページ</a>
            </nav>
        </div>
    </header>

    <!-- メニューモーダル -->
    <div class="menu-modal" id="menuModal">
        <div class="menu-content">
            <div class="menu-header">
                <h2>メニュー</h2>
                <button class="menu-close" id="menuClose">✕</button>
            </div>
            
            <div class="menu-section">
                <h3>ユーザー向け</h3>
                <a href="../../index.html" class="menu-item">
                    <span class="menu-item-icon">🏠</span>
                    <span>トップページ</span>
                </a>
                <a href="mypage.html" class="menu-item">
                    <span class="menu-item-icon">👤</span>
                    <span>マイページ</span>
                </a>
            </div>
            
            <div class="menu-section">
                <h3>ホテルパートナー向け</h3>
                <a href="../partner/dashboard.html" class="menu-item">
                    <span class="menu-item-icon">📊</span>
                    <span>管理画面</span>
                </a>
            </div>
            
            <div class="menu-footer">
                <button class="logout-button" onclick="handleLogout()">
                    <span class="menu-item-icon">🚪</span>
                    <span>ログアウト</span>
                </button>
            </div>
        </div>
    </div>

    <main class="container">
        <!-- ガチャ演出動画 -->
        <div id="gachaAnimation" class="gacha-fullscreen" style="display: none;">
            <video id="gachaVideo" class="gacha-video" muted playsinline>
                <source src="../../assets/images/ガチャ演出.mp4" type="video/mp4">
                お使いのブラウザは動画タグをサポートしていません。
            </video>
        </div>

        <!-- 当日わかるガチャの場合の表示 -->
        <div id="pendingResult" class="card" style="display: none;">
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 5rem; margin-bottom: 20px;">🎁</div>
                <h1 style="color: #667eea; margin-bottom: 20px;">予約が完了しました！</h1>
                <p style="font-size: 1.2rem; margin-bottom: 30px;">
                    宿泊先は<span id="revealDate" style="color: #f5576c; font-weight: bold;"></span>に発表されます
                </p>
                <div class="countdown">
                    <p style="margin-bottom: 10px;">発表まで</p>
                    <div class="countdown-number" id="countdownDays">--</div>
                    <p>日</p>
                </div>
                <button class="btn btn-primary" style="margin-top: 30px;" onclick="window.location.href='mypage.html'">
                    マイページで詳細を確認
                </button>
            </div>
        </div>

        <!-- 結果表示 -->
        <div id="resultContainer" class="result-container" style="display: none;">
            <div class="card">
                <h1 id="congratsMessage" style="text-align: center; color: #667eea; margin-bottom: 30px;">
                    🎉 おめでとうございます！
                </h1>
                
                <img id="hotelImage" class="hotel-image" src="" alt="">
                
                <div class="hotel-info">
                    <h2 id="hotelName"></h2>
                    
                    <div class="hotel-meta">
                        <div class="meta-item">
                            <span>📍</span>
                            <span id="hotelAddress"></span>
                        </div>
                        <div class="meta-item">
                            <span>📞</span>
                            <span id="hotelPhone"></span>
                        </div>
                        <div class="meta-item">
                            <span>🕐</span>
                            <span>チェックイン: <span id="checkInTime"></span></span>
                        </div>
                        <div class="meta-item">
                            <span>🕑</span>
                            <span>チェックアウト: <span id="checkOutTime"></span></span>
                        </div>
                    </div>
                    
                    <p id="hotelDescription" style="margin-top: 20px; line-height: 1.8; color: #666;"></p>
                    
                    <div class="features-grid" id="featuresGrid">
                        <!-- 特徴タグがここに表示される -->
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 15px;">📋 予約詳細</h3>
                <div id="reservationDetails">
                    <!-- 予約詳細がここに表示される -->
                </div>
            </div>

            <!-- 観光プランセクション -->
            <div id="tourismPlanContainer" style="margin-top: 20px;">
                <!-- 観光プランがここに表示される -->
            </div>

            <div style="text-align: center; margin-top: 30px;">
                <button id="retryButton" class="btn btn-warning" style="margin-bottom: 10px; display: none;">
                    もう一度回す<span id="retryCount"></span>
                </button>
                <button id="referralButton" class="btn btn-info" style="margin-bottom: 10px; display: none;">
                    🎁 友達を紹介してもう一度回す
                </button>
                <div>
                    <button class="btn btn-success" onclick="window.location.href='mypage.html'">
                        この宿で予約確定
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Canvas Confetti ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script src="../../js/data.js"></script>
    <script src="../../js/tourism-data.js"></script>
    <script src="../../js/image-loader.js"></script>
    <script src="../../js/menu.js"></script>
    <script src="../../js/confetti.js"></script>
    <script>
        const reservationId = sessionStorage.getItem('latestReservationId');
        
        if (!reservationId) {
            window.location.href = '../../index.html';
        }

        // 予約情報を取得
        const reservations = getReservations();
        const reservation = reservations.find(r => r.id === reservationId);
        
        if (!reservation) {
            window.location.href = '../../index.html';
        }

        // ホテル情報を取得
        const hotels = getHotels();
        const hotel = hotels.find(h => h.id === reservation.hotelId);

        // プランタイプに応じて表示を分岐
        if (reservation.planType === 'instant' || reservation.status === 'revealed') {
            showGachaAnimation();
        } else {
            showPendingResult();
        }

        function showGachaAnimation() {
            document.getElementById('gachaAnimation').style.display = 'flex';
            const video = document.getElementById('gachaVideo');
            
            // 動画を最初から再生
            video.currentTime = 0;
            
            // 動画再生を試みる
            const playPromise = video.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        // 再生成功
                        console.log('動画再生開始');
                    })
                    .catch((error) => {
                        console.error('動画再生エラー:', error);
                        // 再生できない場合は3秒後に結果を表示
                        setTimeout(() => {
                            document.getElementById('gachaAnimation').style.display = 'none';
                            showResult();
                        }, 3000);
                    });
            }
            
            // 動画終了時に結果を表示
            video.addEventListener('ended', function() {
                document.getElementById('gachaAnimation').style.display = 'none';
                showResult();
            }, { once: true }); // イベントリスナーを一度だけ実行
            
            // タイムアウトを設定（動画が10秒以上の場合の保険）
            setTimeout(() => {
                if (document.getElementById('gachaAnimation').style.display !== 'none') {
                    document.getElementById('gachaAnimation').style.display = 'none';
                    showResult();
                }
            }, 10000);
        }

        function showPendingResult() {
            document.getElementById('pendingResult').style.display = 'block';
            
            const revealDate = new Date(reservation.revealDate);
            document.getElementById('revealDate').textContent = revealDate.toLocaleDateString('ja-JP');
            
            // カウントダウン計算
            const now = new Date();
            const daysUntilReveal = Math.ceil((revealDate - now) / (1000 * 60 * 60 * 24));
            document.getElementById('countdownDays').textContent = daysUntilReveal;
        }

        function showResult() {
            document.getElementById('resultContainer').style.display = 'block';
            
            // 特別ホテルの場合は特別な演出
            if (hotel.id === 'hotel_001' || hotel.id === 'hotel_010') {
                // お祝いメッセージを特別仕様に
                const congratsMessage = document.getElementById('congratsMessage');
                congratsMessage.innerHTML = '<span class="jackpot-text">🎊 おめでとうございます！ 🎊</span>';
                congratsMessage.classList.add('jackpot-animation');
                
                setTimeout(() => {
                    showConfetti();
                }, 500); // 結果表示から少し遅らせて演出
            }
            
            // ホテル情報を表示
            const hotelImage = document.getElementById('hotelImage');
            loadHotelImage(hotelImage, hotel, '../../');
            // ホテル名を表示（hotel_001の場合は特別バッジ付き）
            const hotelNameElement = document.getElementById('hotelName');
            hotelNameElement.textContent = hotel.name;
            if (hotel.id === 'hotel_001' || hotel.id === 'hotel_010') {
                const badge = document.createElement('span');
                badge.className = 'special-badge';
                badge.textContent = '✨ スペシャル';
                hotelNameElement.appendChild(badge);
            }
            document.getElementById('hotelAddress').textContent = hotel.address;
            document.getElementById('hotelPhone').textContent = hotel.phone;
            document.getElementById('checkInTime').textContent = hotel.checkIn;
            document.getElementById('checkOutTime').textContent = hotel.checkOut;
            document.getElementById('hotelDescription').textContent = hotel.description;
            
            // 特徴タグ
            const featuresGrid = document.getElementById('featuresGrid');
            hotel.features.forEach(feature => {
                const tag = document.createElement('span');
                tag.className = 'feature-tag';
                tag.textContent = feature;
                featuresGrid.appendChild(tag);
            });
            
            // 予約詳細
            const checkInDate = new Date(reservation.checkInDate);
            const checkOutDate = new Date(reservation.checkInDate);
            checkOutDate.setDate(checkOutDate.getDate() + reservation.nights);
            
            document.getElementById('reservationDetails').innerHTML = `
                <div style="display: grid; gap: 10px; font-size: 0.95rem;">
                    <div><strong>予約番号:</strong> ${reservation.id}</div>
                    <div><strong>宿泊者名:</strong> ${reservation.guestName}</div>
                    <div><strong>チェックイン:</strong> ${checkInDate.toLocaleDateString('ja-JP')}</div>
                    <div><strong>チェックアウト:</strong> ${checkOutDate.toLocaleDateString('ja-JP')}</div>
                    <div><strong>宿泊数:</strong> ${reservation.nights}泊</div>
                    <div><strong>人数:</strong> ${reservation.guests}名</div>
                    <div><strong>料金:</strong> ¥${reservation.price.toLocaleString()}</div>
                    ${reservation.attempts > 1 ? `<div style="color: #f5576c;"><strong>ガチャ回数:</strong> ${reservation.attempts}回目${reservation.referralBonus ? ' (友達紹介ボーナス)' : ''}</div>` : ''}
                </div>
            `;
            
            // 観光プランを表示
            const tourismPlanHTML = generateTourismPlanHTML(hotel.area);
            if (tourismPlanHTML) {
                document.getElementById('tourismPlanContainer').innerHTML = tourismPlanHTML;
            }
            
            // もう一度回すボタンの表示制御（最大2回まで）
            if (reservation.attempts < 2) {
                document.getElementById('retryButton').style.display = 'inline-block';
                document.getElementById('retryCount').textContent = `（残り${2 - reservation.attempts}回）`;
            } else {
                // 2回回した後は紹介ボタンを表示
                document.getElementById('referralButton').style.display = 'inline-block';
            }
        }
        
        // もう一度回すボタンの処理
        document.getElementById('retryButton').addEventListener('click', function() {
            let warningMessage;
            
            // 2回目（最後）の警告
            warningMessage = '⚠️ 最終警告：これが最後のガチャです！\n\n' +
                            '・次の結果で確定となります\n' +
                            '・もう変更はできません\n' +
                            '・現在の宿には戻れません\n\n' +
                            '本当に最後のガチャを回しますか？';
            
            if (!confirm(warningMessage)) {
                return;
            }
            
            // 新しいホテルを選択
            const hotels = getHotels().filter(h => h.area === reservation.area && h.id !== reservation.hotelId);
            if (hotels.length === 0) {
                alert('他の宿泊施設が見つかりません。');
                return;
            }
            
            const newHotel = hotels[Math.floor(Math.random() * hotels.length)];
            
            // 既存の予約を更新
            const reservations = getReservations();
            const index = reservations.findIndex(r => r.id === reservation.id);
            if (index !== -1) {
                reservations[index].hotelId = newHotel.id;
                reservations[index].attempts = (reservations[index].attempts || 1) + 1;
                localStorage.setItem('yadogacha_reservations', JSON.stringify(reservations));
            }
            
            // ページをリロード
            window.location.reload();
        });
        
        // 友達紹介ボタンの処理
        document.getElementById('referralButton').addEventListener('click', function() {
            if (confirm('👥 友達紹介ボーナス！\n\n友達を紹介していただいたお礼として、特別にもう1回ガチャを回せます！\n\n続行しますか？')) {
                // 新しいホテルを選択
                const hotels = getHotels().filter(h => h.area === reservation.area && h.id !== reservation.hotelId);
                if (hotels.length === 0) {
                    alert('他の宿泊施設が見つかりません。');
                    return;
                }
                
                const newHotel = hotels[Math.floor(Math.random() * hotels.length)];
                
                // 既存の予約を更新（attempts を3に設定して、紹介ボーナスであることを記録）
                const reservations = getReservations();
                const index = reservations.findIndex(r => r.id === reservation.id);
                if (index !== -1) {
                    reservations[index].hotelId = newHotel.id;
                    reservations[index].attempts = 3; // 紹介ボーナス
                    reservations[index].referralBonus = true;
                    localStorage.setItem('yadogacha_reservations', JSON.stringify(reservations));
                }
                
                // ページをリロード
                window.location.reload();
            }
        });
    </script>
</body>
</html>